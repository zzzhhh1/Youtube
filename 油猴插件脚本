// ==UserScript==
// @name                ä¿®æ”¹YouTubeé¦–é¡µå¸ƒå±€
// @name:zh-CN          ä¿®æ”¹YouTubeé¦–é¡µå¸ƒå±€
// @name:zh-TW          ä¿®æ”¹YouTubeé¦–é ä½ˆå±€
// @name:en             Modify YouTube Homepage Layout
// @name:ja             YouTubeãƒ›ãƒ¼ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
// @description         ä¿®æ”¹YouTubeé¦–é¡µæ¯è¡Œæ¨èè§†é¢‘æ•°é‡
// @description:zh-CN   ä¿®æ”¹YouTubeé¦–é¡µæ¯è¡Œæ¨èè§†é¢‘æ•°é‡
// @description:zh-TW   ä¿®æ”¹YouTubeé¦–é æ¯è¡Œæ¨è–¦è¦–é »æ•¸é‡
// @description:en      Change the number of recommended videos per row on the YouTube homepage
// @description:ja      YouTubeã®ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã§1è¡Œã«è¡¨ç¤ºã•ã‚Œã‚‹ãŠã™ã™ã‚å‹•ç”»ã®æ•°ã‚’å¤‰æ›´ã—ã¾ã™
// @version             1.5
// @author              çˆ†èŠå¤§å¸ˆ
// @match               https://www.youtube.com/
// @icon                https://www.youtube.com/favicon.ico
// @grant               GM_registerMenuCommand
// @run-at              document-idle
// @license             MIT
// @namespace https://greasyfork.org/users/929164
// @downloadURL https://update.greasyfork.org/scripts/533051/%E4%BF%AE%E6%94%B9YouTube%E9%A6%96%E9%A1%B5%E5%B8%83%E5%B1%80.user.js
// @updateURL https://update.greasyfork.org/scripts/533051/%E4%BF%AE%E6%94%B9YouTube%E9%A6%96%E9%A1%B5%E5%B8%83%E5%B1%80.meta.js
// ==/UserScript==

(() => {
    'use strict';
    const CONFIG = {
        columns: 'ytd-items-per-row',
        shorts: 'ytd-shorts-blocked',
        portraitColumns: 'ytd-portrait-columns'
    };
    const state = {
        columns: Math.min(10, Math.max(1,
            parseInt(localStorage.getItem(CONFIG.columns)) || 5)),
        shorts: localStorage.getItem(CONFIG.shorts) === 'true',
        portraitColumns: parseInt(localStorage.getItem(CONFIG.portraitColumns)) || null,
        styleApplied: false
    };

    // åˆ›å»ºæ ·å¼å…ƒç´ ï¼Œç¡®ä¿åªåˆ›å»ºä¸€æ¬¡
    let layoutStyle, shortsStyle;
    const createStyles = () => {
        if (!layoutStyle) {
            layoutStyle = document.head.appendChild(document.createElement('style'));
            layoutStyle.id = 'yt-layout-customizer';
        }
        if (!shortsStyle) {
            shortsStyle = document.head.appendChild(document.createElement('style'));
            shortsStyle.id = 'yt-shorts-customizer';
        }
    };

    const handleResize = () => {
        if (state.portraitColumns !== null) {
            const { innerWidth: width, innerHeight: height } = window;
            const originalColumns = Math.min(10, Math.max(1,
                parseInt(localStorage.getItem(CONFIG.columns)) || 5));
            state.columns = width > height ? originalColumns : state.portraitColumns;
            updateStyle();
        }
    };

    const updateStyle = () => {
        createStyles();
        layoutStyle.textContent = `
            .style-scope.ytd-two-column-browse-results-renderer {
                --ytd-rich-grid-items-per-row: ${state.columns} !important;
                --ytd-rich-grid-gutter-margin: 0px !important;
            }
        `;
        shortsStyle.textContent = state.shorts ? `
            ytd-rich-section-renderer,
            ytd-reel-shelf-renderer {
                display: none !important;
            }
        ` : '';
        state.styleApplied = true;
    };

    // æ³¨å†Œèœå•å‘½ä»¤
    const registerMenuCommands = () => {
        GM_registerMenuCommand('ğŸ–¥ï¸ è®¾ç½®æ¯è¡Œæ˜¾ç¤ºæ•°é‡', () => {
            const input = prompt('è¯·è¾“å…¥æ¯è¡Œæ˜¾ç¤ºçš„è§†é¢‘æ•°é‡ï¼ˆ1-10ï¼‰:', state.columns);
            if (input === null) return;

            const value = Math.min(10, Math.max(1, parseInt(input) || state.columns));
            localStorage.setItem(CONFIG.columns, value);
            state.columns = value;
            handleResize();
            updateStyle();
            alert(`å½“å‰è®¾ç½®ï¼šæ¯è¡Œæ˜¾ç¤º ${value} ä¸ªè§†é¢‘`);
        });

        GM_registerMenuCommand('ğŸ“± ç«–å±æ˜¾ç¤ºæ•°é‡', () => {
            const input = prompt(`çºµå‘æ¨¡å¼åˆ—æ•°ï¼ˆ1-10ï¼Œå½“å‰ï¼š${state.portraitColumns || "æœªè®¾ç½®"}ï¼‰:`, state.portraitColumns || 6);
            if (input === null) return;
            const value = Math.min(10, Math.max(1, parseInt(input) || 6));
            localStorage.setItem(CONFIG.portraitColumns, value);
            state.portraitColumns = value;
            handleResize();
            alert(`ç«–å±å½“å‰è®¾ç½®ï¼šæ¯è¡Œæ˜¾ç¤º ${value} ä¸ªè§†é¢‘`);
        });

        if (state.portraitColumns !== null) {
            GM_registerMenuCommand('æ¸…é™¤ç«–å±è®¾ç½®', () => {
                if (!confirm('ç¡®å®šè¦æ¸…é™¤ç«–å±è®¾ç½®å—ï¼Ÿ')) return;
                localStorage.removeItem(CONFIG.portraitColumns);
                state.portraitColumns = null;
                state.columns = Math.min(10, Math.max(1,
                    parseInt(localStorage.getItem(CONFIG.columns)) || 5));
                updateStyle();
                alert('å·²æ¸…é™¤ç«–å±è®¾ç½®');
            });
        }

        GM_registerMenuCommand(state.shorts ? 'æ˜¾ç¤ºShorts' : 'éšè—Shorts', () => {
            state.shorts = !state.shorts;
            localStorage.setItem(CONFIG.shorts, state.shorts);
            updateStyle();
            window.location.reload();
        });
    };

    // ç¡®ä¿æ ·å¼åº”ç”¨ï¼Œä½†ç­‰å¾…å†…å®¹åŠ è½½
    const ensureStylesApplied = () => {
        // ç­‰å¾…ç¼©ç•¥å›¾åŠ è½½çš„å…³é”®å…ƒç´ 
        const waitForThumbnails = () => {
            // æ£€æŸ¥æ˜¯å¦æœ‰è§†é¢‘ç¼©ç•¥å›¾å·²ç»åŠ è½½
            const thumbnails = document.querySelectorAll('ytd-rich-grid-media, ytd-rich-item-renderer');
            const thumbnailsLoaded = document.querySelectorAll('ytd-thumbnail img[src]').length > 0;

            if (thumbnails.length > 0 && thumbnailsLoaded) {
                // ç¼©ç•¥å›¾å…ƒç´ å·²å­˜åœ¨ä¸”è‡³å°‘æœ‰ä¸€å¼ å›¾ç‰‡å·²åŠ è½½ï¼Œåº”ç”¨æ ·å¼
                updateStyle();
                return true;
            }
            return false;
        };

        // å¦‚æœç«‹å³æ£€æŸ¥èƒ½æ‰¾åˆ°å…ƒç´ ï¼Œå°±ç›´æ¥åº”ç”¨æ ·å¼
        if (waitForThumbnails()) {
            return;
        }

        // ä½¿ç”¨MutationObserverç›‘å¬DOMå˜åŒ–ï¼Œç­‰å¾…ç¼©ç•¥å›¾åŠ è½½
        const observer = new MutationObserver((mutations) => {
            if (waitForThumbnails()) {
                // ä¸€æ—¦æ‰¾åˆ°ç¼©ç•¥å›¾å¹¶åº”ç”¨äº†æ ·å¼ï¼Œå°±åœæ­¢è§‚å¯Ÿ
                observer.disconnect();
            }
        });

        // å¼€å§‹è§‚å¯Ÿdocumentçš„å­æ ‘å˜åŒ–
        observer.observe(document.documentElement, {
            childList: true,
            subtree: true,
            attributes: true,
            attributeFilter: ['src']
        });

        // è®¾ç½®ä¸€ä¸ªå¤‡ç”¨çš„å®šæ—¶æ£€æŸ¥æœºåˆ¶
        let checkCount = 0;
        const maxChecks = 20; // æœ€å¤šæ£€æŸ¥20æ¬¡ï¼Œçº¦10ç§’

        const checkInterval = setInterval(() => {
            checkCount++;
            if (waitForThumbnails() || checkCount >= maxChecks) {
                clearInterval(checkInterval);
                observer.disconnect();

                // å¦‚æœè¾¾åˆ°æœ€å¤§æ£€æŸ¥æ¬¡æ•°ä»æœªæ‰¾åˆ°ç¼©ç•¥å›¾ï¼Œå°è¯•å¼ºåˆ¶åº”ç”¨æ ·å¼
                if (checkCount >= maxChecks && !state.styleApplied) {
                    console.log('YouTubeå¸ƒå±€ä¼˜åŒ–: å¼ºåˆ¶åº”ç”¨æ ·å¼');
                    updateStyle();
                }
            }
        }, 500);
    };

    // åˆå§‹åŒ–
    const init = () => {
        // ä¿®å¤çŠ¶æ€å¦‚æœæ— æ•ˆ
        if (typeof state.columns !== 'number' || isNaN(state.columns)) {
            state.columns = 5;
        }

        // æ³¨å†Œäº‹ä»¶ç›‘å¬
        window.addEventListener('resize', handleResize);

        // æ·»åŠ èœå•å‘½ä»¤
        registerMenuCommands();

        // ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆååº”ç”¨æ ·å¼
        if (document.readyState === 'complete') {
            setTimeout(ensureStylesApplied, 1000); // å»¶è¿Ÿ1ç§’è®©YouTubeå®Œæˆåˆå§‹æ¸²æŸ“
        } else {
            window.addEventListener('load', () => {
                setTimeout(ensureStylesApplied, 1000);
            });
        }

        // åˆå§‹è°ƒç”¨ä¸€æ¬¡resizeå¤„ç†
        handleResize();
    };

    // å¯åŠ¨è„šæœ¬
    init();
})();
